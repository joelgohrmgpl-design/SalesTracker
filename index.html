<!doctype html>
<html lang="en">
<head>
  <!-- PWA manifest & mobile app meta -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2563eb">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sales Order Tracker</title>
  <style>
    :root {
      --bg: #f3f5f9;
      --bg-alt: #ffffff;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --accent-dark: #1d4ed8;
      --border: #d5d8e3;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 12px;
      --radius-md: 10px;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-subtle: 0 4px 14px rgba(15, 23, 42, 0.04);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #e5edff 0, #f3f5f9 52%, #edf1f7 100%);
      -webkit-text-size-adjust: 100%;
    }

    body {
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
    }

    /* HEADER */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .title-block h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-pill {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5f6ff;
      color: #0369a1;
      font-weight: 600;
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .search-wrapper {
      position: relative;
      flex: 1 1 220px;
      min-width: 0;
    }

    .search {
      width: 100%;
      padding: 9px 32px 9px 28px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 13px;
      background: #ffffff;
      box-shadow: var(--shadow-subtle);
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .search:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
      background: #f9fbff;
    }

    .search-icon {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button {
      border-radius: 999px;
      padding: 9px 13px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      min-height: 38px;
      touch-action: manipulation;
    }

    button svg {
      width: 14px;
      height: 14px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #f9fafb;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.28);
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    button.primary:hover {
      background: linear-gradient(135deg, var(--accent-dark), #1e40af);
    }

    button.ghost {
      background: #ffffff;
      color: var(--text-muted);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-subtle);
    }

    button.ghost:hover {
      background: #f9fafb;
      color: #111827;
    }

    button.danger-ghost {
      background: #fff1f2;
      color: var(--danger);
      border: 1px solid #fecaca;
      box-shadow: none;
    }

    button.danger-ghost:hover {
      background: #fee2e2;
    }

    /* SUMMARY BAR */

    .summary-bar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      border-radius: var(--radius-lg);
      padding: 10px 14px;
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 14px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209, 213, 219, 0.7);
      overflow-x: auto;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      min-width: 110px;
      flex-shrink: 0;
    }

    .summary-item span.value {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
      margin-top: 3px;
      text-transform: none;
      letter-spacing: 0;
    }

    .summary-separator {
      width: 1px;
      height: 32px;
      background: linear-gradient(to bottom, transparent, #cbd5f5, transparent);
      flex-shrink: 0;
    }

    /* MAIN GRID */

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(320px, 1fr);
      gap: 14px;
      align-items: flex-start;
    }

    .panel {
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-header h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .panel-header span.muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* TABLE */

    .table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      background: #ffffff;
      max-height: 540px;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      min-width: 760px;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 7px 10px;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
    }

    th {
      background: #f9fafb;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: #fcfcff;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    .small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .esa-cell strong {
      font-size: 13px;
    }

    td.actions {
      width: 140px;
      white-space: nowrap;
    }

    .row-complete td {
      background: #f0fdf4 !important;
    }

    .status-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf3;
      color: #15803d;
      font-weight: 600;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .progress-wrap {
      margin-top: 4px;
    }

    .progress-bar {
      position: relative;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.2s ease;
    }

    .progress-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .task-button {
      margin-top: 6px;
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      color: #4b5563;
      cursor: pointer;
    }

    .task-button:hover {
      background: #eef2ff;
      border-style: solid;
      border-color: #cbd5f5;
    }

    /* FORM */

    form.add {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1.2fr 1.1fr;
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field label {
      font-weight: 500;
      color: #4b5563;
    }

    .field label span.req {
      color: #ef4444;
      margin-left: 2px;
    }

    .field input[type="text"],
    .field input[type="date"],
    .field textarea {
      padding: 7px 9px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      background: #ffffff;
    }

    .field input[type="text"]:focus,
    .field input[type="date"]:focus,
    .field textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
      background: #f9fbff;
    }

    .field textarea {
      resize: vertical;
      min-height: 48px;
      max-height: 110px;
    }

    details {
      border-radius: 8px;
      border: 1px dashed var(--border);
      padding: 6px 8px;
      background: #f9fafb;
      font-size: 12px;
    }

    details[open] {
      background: #eef2ff;
      border-style: solid;
    }

    details summary {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      list-style: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    .summary-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: #1f2937;
    }

    .summary-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tasks-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      margin-top: 8px;
      max-height: 210px;
      overflow-y: auto;
      padding-right: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .task-category-label {
      margin: 10px 0 4px;
      font-weight: 600;
      font-size: 11px;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 2px;
      grid-column: 1 / -1;
    }

    .tasks-grid label {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 11px;
      color: #374151;
    }

    .tasks-grid input[type="checkbox"],
    .tasks-grid input[type="date"] {
      transform: scale(0.95);
    }

    .form-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .panel.small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .panel.small ul {
      padding-left: 18px;
      margin: 6px 0 0;
    }

    .panel.small li {
      margin-bottom: 3px;
    }

    /* TASK PANEL UNDER ROW */

    tr.task-panel td {
      background: #f9fafb !important;
      padding: 10px 12px;
    }

    .task-panel-wrap {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 14px;
      font-size: 11px;
    }

    .task-panel-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-panel-item span {
      color: #374151;
    }

    .task-panel-category {
      grid-column: 1 / -1;
      margin-top: 6px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 2px;
    }

    /* RESPONSIVE */

    @media (max-width: 980px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .controls {
        width: 100%;
        justify-content: stretch;
      }

      .toolbar {
        width: 100%;
        justify-content: stretch;
      }

      .toolbar button {
        flex: 1 1 auto;
        justify-content: center;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .table-wrapper {
        max-height: none;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 12px;
      }

      .title-block h1 {
        font-size: 19px;
      }

      .summary-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .summary-separator {
        display: none;
      }

      .field-row {
        grid-template-columns: 1fr;
      }

      .task-panel-wrap {
        grid-template-columns: 1fr;
      }

      .tasks-grid {
        grid-template-columns: 1fr;
      }

      td.actions {
        width: auto;
      }

      button {
        padding-inline: 11px;
      }
    }

    @media (max-width: 480px) {
      .panel {
        padding: 12px 10px;
      }

      header {
        gap: 10px;
      }

      .title-block p {
        font-size: 12px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .toolbar {
        flex-direction: column;
      }

      .toolbar button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>
          Sales Order Tracker
          <span class="title-pill">Internal Tool</span>
        </h1>
        <p>Track ESA#, loan progress, insurance, COE, stock allocation, and handover in one place.</p>
      </div>
      <div class="controls">
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input id="search" class="search" placeholder="Search ESA#, Chasis, Name..." />
        </div>
        <div class="toolbar">
          <button id="exportCsv" class="primary">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path fill="currentColor"
                d="M10 2a.75.75 0 0 1 .75.75v7.19l2.22-2.22a.75.75 0 1 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5A.75.75 0 0 1 6.47 7.7L8.69 9.9V2.75A.75.75 0 0 1 10 2Z" />
              <path fill="currentColor"
                d="M4.25 12.5a.75.75 0 0 1 .75.75v1.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-1.5a.75.75 0 0 1 1.5 0v1.5A2.25 2.25 0 0 1 14.25 18h-8.5A2.25 2.25 0 0 1 3.5 15.75v-1.5a.75.75 0 0 1 .75-.75Z" />
            </svg>
            Export CSV
          </button>
          <button id="importBtn" class="ghost">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path fill="currentColor"
                d="M10 2a2.75 2.75 0 0 1 2.75 2.75v1.5a.75.75 0 0 1-1.5 0v-1.5A1.25 1.25 0 0 0 10 3.5H6.75A1.25 1.25 0 0 0 5.5 4.75v10.5A1.25 1.25 0 0 0 6.75 16.5h6.5a1.25 1.25 0 0 0 1.25-1.25V11a.75.75 0 0 1 1.5 0v4.25A2.75 2.75 0 0 1 13.25 18h-6.5A2.75 2.75 0 0 1 4 15.25V4.75A2.75 2.75 0 0 1 6.75 2H10Z" />
              <path fill="currentColor"
                d="M14.53 4.22a.75.75 0 0 0-1.06 1.06l.97.97H10a.75.75 0 0 0 0 1.5h4.44l-.97.97a.75.75 0 1 0 1.06 1.06l2.25-2.25a.75.75 0 0 0 0-1.06L14.53 4.22Z" />
            </svg>
            Import CSV
          </button>
          <button id="clearAll" class="danger-ghost">
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path fill="currentColor"
                d="M7.25 3.5A1.75 1.75 0 0 1 9 1.75h2a1.75 1.75 0 0 1 1.75 1.75h3.5a.75.75 0 0 1 0 1.5h-.57l-.62 10.08A2.25 2.25 0 0 1 12.83 19H9.17a2.25 2.25 0 0 1-2.23-2.42L6.32 5H5.75a.75.75 0 0 1 0-1.5h3.5Zm1.5 0h2.5a.25.25 0 0 0-.25-.25H9a.25.25 0 0 0-.25.25Z" />
            </svg>
            Clear All
          </button>
        </div>
      </div>
    </header>

    <div id="summaryBar" class="summary-bar">
      <div class="summary-item">
        TOTAL ORDERS
        <span class="value" id="summaryTotal">0</span>
      </div>
      <div class="summary-separator"></div>
      <div class="summary-item">
        FULLY COMPLETED
        <span class="value" id="summaryCompleted">0</span>
      </div>
      <div class="summary-separator"></div>
      <div class="summary-item">
        COMPLETION RATE
        <span class="value" id="summaryRate">0%</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: ORDERS TABLE -->
      <div class="panel">
        <div class="panel-header">
          <h3>
            Orders
            <span class="pill">Tracker</span>
          </h3>
          <span class="muted">Use the form on the right to add or edit an order.</span>
        </div>
        <div class="table-wrapper">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>ESA# / ID</th>
                <th>Chasis Number</th>
                <th>Customer</th>
                <th>Remarks</th>
                <th>Progress</th>
                <th>Last updated</th>
                <th class="actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: FORM -->
      <div>
        <div class="panel">
          <div class="panel-header">
            <h3>Add / Edit Order</h3>
            <span class="muted" id="formMode">New record</span>
          </div>
          <form id="orderForm" class="add">
            <input type="hidden" id="editId" />

            <div class="field-row">
              <div class="field">
                <label for="esa">ESA# <span class="req">*</span></label>
                <input id="esa" type="text" placeholder="e.g. ESA12345" required />
              </div>
              <div class="field">
                <label for="chasis">Chasis Number</label>
                <input id="chasis" type="text" placeholder="Chasis number" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label for="name">Customer Name</label>
                <input id="name" type="text" placeholder="Customer name" />
              </div>
              <div class="field">
                <label for="remarks">Remarks</label>
                <textarea id="remarks" placeholder="Internal notes or special requests"></textarea>
              </div>
            </div>

            <details>
              <summary>
                <span class="summary-text">Tasks</span>
                <span class="summary-sub">Click to expand categories (Document, Loan, Insurance, COE, etc.)</span>
              </summary>
              <div class="tasks-grid">
                <!-- Tasks checkboxes will be injected here -->
              </div>
            </details>

            <div class="form-actions">
              <button type="submit" class="primary">
                Save Order
              </button>
              <button type="button" id="resetBtn" class="ghost">
                Reset Form
              </button>
            </div>

            <div class="hint">
              Data is saved automatically in your browser (localStorage). You can export to CSV for backup or Excel.
            </div>
          </form>
        </div>

        <div class="panel small" style="margin-top:10px;">
          <strong>Tips</strong>
          <ul>
            <li>The tracker works entirely in your browser and can work offline.</li>
            <li>Use <strong>Export CSV</strong> regularly as a backup.</li>
            <li>Only import CSV files exported from this tool to avoid format issues.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Columns/tasks from your list
    const TASKS = [
      'CAT:Document & Portal Submission',
      'Upload to portal',
      'Submit documents to Admin',
      'Inform Admin portal submit - Sales Group',
      'Check Loan Status approved',

      'CAT:Loan Process',
      'Get Greenlight from customer',
      'Screenshot SMS Greenlight',

      'CAT:Insurance & COE',
      'Quote higher excess - inform admin in Group insurance',
      'Inform Loan group proceed COE & loan',
      'Inform Group Insurance to cover insurance',

      'CAT:Stock Allocation',
      'Reserve Red Stocklist - sales group',

      'CAT:Accessories',
      'Accessories',
      '3M',
      'Car Mat',
      'IVShine',

      'CAT:Pre-Registration',
      '1 week before registration ask customer make payment',

      'CAT:Carplate & CI',
      'Order carplate from carplate group & send CI to customer',

      'CAT:Delivery Preparation',
      'Inform Showroom manager when car coming/handover date',
      'Print documents for customer to sign',

      'CAT:Final',
      'Handover Date'
    ];

    // Basic utilities
    const uid = () =>
      Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    const $ = (q) => document.querySelector(q);
    const tbody = document.querySelector('#ordersTable tbody');
    const STORAGE_KEY = 'sales-order-tracker-v1';
    let orders = [];

    // Build tasks inputs in the form details with numbering (UI only)
    (function buildTaskCheckboxes() {
      const container = document.querySelector('details .tasks-grid');
      let displayIndex = 0; // count only real tasks (exclude CAT labels)

      TASKS.forEach((t, i) => {
        if (t.startsWith('CAT:')) {
          const hdr = document.createElement('div');
          hdr.className = 'task-category-label';
          hdr.textContent = t.replace('CAT:', '');
          container.appendChild(hdr);
          return;
        }
        displayIndex++;
        const id = 't_' + i;
        const labelText = t.replace(/"/g, '');
        const numberedText = displayIndex + '. ' + labelText;

        const wrap = document.createElement('label');
        if (t === 'Handover Date') {
          wrap.innerHTML =
            '<input type="date" data-task-index="' +
            i +
            '" id="' +
            id +
            '" /> <span>' +
            numberedText +
            '</span>';
        } else {
          wrap.innerHTML =
            '<input type="checkbox" data-task-index="' +
            i +
            '" id="' +
            id +
            '" /> <span>' +
            numberedText +
            '</span>';
        }
        container.appendChild(wrap);
      });
    })();

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
    }
    function load() {
      try {
        orders = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch (e) {
        orders = [];
      }
    }

    function updateSummary() {
      const totalOrders = orders.length;

      // total real tasks (exclude CAT: categories)
      const totalTasks = TASKS.filter((t) => !t.startsWith('CAT:')).length;

      let completedOrders = 0;
      orders.forEach((o) => {
        let done = 0;
        TASKS.forEach((t, i) => {
          if (t.startsWith('CAT:')) return;
          if (o.tasks && o.tasks[i]) done++;
        });
        if (done === totalTasks && totalTasks > 0) completedOrders++;
      });

      const rate =
        totalOrders > 0
          ? Math.round((completedOrders / totalOrders) * 100)
          : 0;

      $('#summaryTotal').textContent = totalOrders;
      $('#summaryCompleted').textContent = completedOrders;
      $('#summaryRate').textContent = rate + '%';
    }

    function render() {
      tbody.innerHTML = '';
      const q = $('#search').value.trim().toLowerCase();
      const rows = orders.filter((o) => {
        if (!q) return true;
        return (
          (o.esa || '').toLowerCase().includes(q) ||
          (o.chasis || '').toLowerCase().includes(q) ||
          (o.name || '').toLowerCase().includes(q)
        );
      });

      updateSummary();

      if (rows.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="7" class="small">No orders yet. Use the form on the right to add one.</td></tr>';
        return;
      }

      rows.forEach((o) => {
        const tr = document.createElement('tr');

        // count progress only on real tasks
        let total = 0;
        let completed = 0;
        TASKS.forEach((t, i) => {
          if (t.startsWith('CAT:')) return;
          total++;
          if (o.tasks && o.tasks[i]) completed++;
        });

        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        if (completed === total && total > 0) tr.classList.add('row-complete');

        tr.innerHTML = `
          <td class="esa-cell">
            <strong>${escapeHtml(o.esa || '')}</strong>
            <div class="small">ID: ${escapeHtml(o.id)}</div>
          </td>
          <td>${escapeHtml(o.chasis || '')}</td>
          <td>${escapeHtml(o.name || '')}</td>
          <td>${escapeHtml(o.remarks || '')}</td>
          <td>
            ${
              completed === total && total > 0
                ? `<div class="status-tag"><span class="status-dot"></span> Completed</div>`
                : ''
            }
            <div class="progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" style="width:${percent}%;"></div>
              </div>
              <div class="progress-label">${completed} / ${total} tasks</div>
            </div>
            <button type="button" data-id="${
              o.id
            }" class="task-button">View / Toggle tasks</button>
          </td>
          <td class="small">${
            o.updatedAt ? new Date(o.updatedAt).toLocaleString() : ''
          }</td>
          <td class="actions">
            <button data-action="edit" data-id="${o.id}" class="ghost" style="padding:5px 9px;font-size:11px;">Edit</button>
            <button data-action="delete" data-id="${o.id}" class="danger-ghost" style="padding:5px 9px;font-size:11px;">Delete</button>
          </td>
        `;

        tr
          .querySelector('.task-button')
          .addEventListener('click', () => toggleTaskPanel(o, tr));

        tr.querySelectorAll('button[data-action]').forEach((b) => {
          b.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            const action = e.currentTarget.dataset.action;
            if (action === 'edit') loadEdit(id);
            if (action === 'delete') {
              if (confirm('Delete order?')) {
                orders = orders.filter((x) => x.id !== id);
                save();
                render();
              }
            }
          });
        });

        tbody.appendChild(tr);
      });
    }

    function toggleTaskPanel(order, tr) {
      const next = tr.nextElementSibling;
      if (next && next.classList.contains('task-panel')) {
        next.remove();
        return;
      }
      const detail = document.createElement('tr');
      detail.className = 'task-panel';
      const td = document.createElement('td');
      td.colSpan = 7;
      const wrap = document.createElement('div');
      wrap.className = 'task-panel-wrap';

      let displayIndex = 0;

      TASKS.forEach((t, i) => {
        if (t.startsWith('CAT:')) {
          const cat = document.createElement('div');
          cat.className = 'task-panel-category';
          cat.textContent = t.replace('CAT:', '');
          wrap.appendChild(cat);
          return;
        }
        displayIndex++;
        const div = document.createElement('div');
        div.className = 'task-panel-item';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!(order.tasks && order.tasks[i]);
        chk.dataset.taskIndex = i;
        chk.addEventListener('change', (e) => {
          order.tasks = order.tasks || [];
          order.tasks[i] = e.currentTarget.checked;
          order.updatedAt = Date.now();
          save();
          render();
        });
        div.appendChild(chk);
        const span = document.createElement('span');
        span.textContent = displayIndex + '. ' + t;
        div.appendChild(span);
        wrap.appendChild(div);
      });

      td.appendChild(wrap);
      detail.appendChild(td);
      tr.parentNode.insertBefore(detail, tr.nextSibling);
    }

    function loadEdit(id) {
      const o = orders.find((x) => x.id === id);
      if (!o) return;
      $('#editId').value = o.id;
      $('#esa').value = o.esa || '';
      $('#chasis').value = o.chasis || '';
      $('#name').value = o.name || '';
      $('#remarks').value = o.remarks || '';
      document
        .querySelectorAll('[data-task-index]')
        .forEach((cb) => (cb.checked = !!(o.tasks && o.tasks[cb.dataset.taskIndex])));
      $('#formMode').textContent = 'Editing existing record';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function escapeHtml(s) {
      return (s || '')
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Form handling
    $('#orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = $('#editId').value || uid();
      const o = {
        id,
        esa: $('#esa').value.trim(),
        chasis: $('#chasis').value.trim(),
        name: $('#name').value.trim(),
        remarks: $('#remarks').value.trim(),
        tasks: [],
        updatedAt: Date.now()
      };
      document.querySelectorAll('[data-task-index]').forEach((cb) => {
        if (cb.type === 'checkbox') {
          o.tasks[cb.dataset.taskIndex] = !!cb.checked;
        } else if (cb.type === 'date') {
          o.tasks[cb.dataset.taskIndex] = cb.value ? true : false;
        }
      });

      const existing = orders.find((x) => x.id === id);
      if (existing) {
        Object.assign(existing, o);
      } else {
        orders.unshift(o);
      }
      save();
      render();
      resetForm();
    });

    $('#resetBtn').addEventListener('click', () => resetForm());
    function resetForm() {
      $('#editId').value = '';
      $('#esa').value = '';
      $('#chasis').value = '';
      $('#name').value = '';
      $('#remarks').value = '';
      document
        .querySelectorAll('[data-task-index]')
        .forEach((cb) => (cb.checked = false));
      $('#formMode').textContent = 'New record';
    }

    // Search
    $('#search').addEventListener('input', () => render());

    // Export CSV
    function toCSV(rows) {
      const headers = ['id', 'esa', 'chasis', 'name', 'remarks', 'updatedAt'].concat(
        TASKS
      );
      const lines = [headers.join(',')];
      rows.forEach((r) => {
        const row = [
          r.id,
          r.esa,
          r.chasis,
          r.name,
          r.remarks || '',
          r.updatedAt || ''
        ];
        TASKS.forEach((_, i) =>
          row.push(r.tasks && r.tasks[i] ? '1' : '0')
        );
        lines.push(
          row
            .map((v) =>
              '"' + (v || '').toString().replace(/"/g, '""') + '"'
            )
            .join(',')
        );
      });
      return lines.join('\n');
    }

    $('#exportCsv').addEventListener('click', () => {
      const csv = toCSV(orders);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sales_orders.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import CSV (simple split; expects same format as export)
    $('#importBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.csv,text/csv';
      input.addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const txt = await f.text();
        parseCsvImport(txt);
      });
      input.click();
    });

    function parseCsvImport(txt) {
      const rows = txt
        .split('\n')
        .map((r) => r.trim())
        .filter((r) => r);
      if (rows.length < 2) return alert('No data');
      const imported = [];
      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i]
          .split(',')
          .map((c) => c.replace(/^"|"$/g, ''));
        if (cols.length < 5) continue;
        const obj = {
          id: cols[0] || uid(),
          esa: cols[1] || '',
          chasis: cols[2] || '',
          name: cols[3] || '',
          remarks: cols[4] || '',
          updatedAt: cols[5] || Date.now(),
          tasks: []
        };
        for (let t = 0; t < TASKS.length; t++) {
          const idx = 6 + t;
          obj.tasks[t] =
            cols[idx] && cols[idx].trim() !== '' && cols[idx] !== '0'
              ? true
              : false;
        }
        imported.push(obj);
      }
      if (imported.length) {
        orders = imported.concat(orders);
        save();
        render();
        alert('Imported ' + imported.length + ' rows');
      } else alert('No rows imported');
    }

    // Clear all
    $('#clearAll').addEventListener('click', () => {
      if (!confirm('Clear all orders from local storage?')) return;
      orders = [];
      save();
      render();
    });

    // Init
    load();
    render();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('service-worker.js').catch(function (err) {
          console.error('Service Worker registration failed:', err);
        });
      });
    }
  </script>

</body>
</html>
